<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <changeSet id="202101081600-1" author="jharriso">
        <preConditions onFail="MARK_RAN">
            <!-- The expectedResult is a little counter-intuitive.  Basically it means, if the
            result of the SQL matches the expectedResult, run the changeset.

            In this case, we only want to try to create the composite primary key if it doesn't
            already exist.  I.e. the query does not find a matching constraint in the
            table_constraints table.
            -->
            <sqlCheck expectedResult="0">
                SELECT CASE
                    WHEN COUNT(*) = 1 THEN 1
                    ELSE 0
                END
                FROM (
                    SELECT tc.constraint_name
                    FROM information_schema.table_constraints tc
                    JOIN information_schema.key_column_usage kcu ON tc.constraint_name = kcu.constraint_name
                    WHERE tc.table_name = 'subscription'
                    AND tc.constraint_type = 'PRIMARY KEY'
                    AND kcu.column_name IN ('subscription_id', 'start_date')
                    GROUP BY tc.constraint_name
                    HAVING COUNT(kcu.column_name) = 2
                )
            </sqlCheck>
        </preConditions>
        <comment>Change primary key</comment>
        <dropPrimaryKey tableName="subscription" />
        <addPrimaryKey tableName="subscription" columnNames="subscription_id,start_date" />
    </changeSet>

</databaseChangeLog>
